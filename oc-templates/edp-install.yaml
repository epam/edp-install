kind: Template
apiVersion: v1
metadata:
  name: edp
  annotations:
    description: |-
          Template for deploying EPAM Delivery Platform (EDP) aka "The Rocket" tools
    openshift.io/display-name: EDP - The Rocket
    template.openshift.io/provider-display-name: EPAM
    template.openshift.io/support-url: https://www.epam.com
objects:
- apiVersion: batch/v1
  kind: Job
  metadata:
    name: edp-deploy${PROJECTS_SUFFIX}
  spec:
    parallelism: 1
    completions: 1
    template:
      metadata:
        name: edp-deploy
      spec:
        restartPolicy: Never
        serviceAccount: edp
        containers:
        - image: ${EDP_VERSION}
          imagePullPolicy: Always
          name: edp-deploy
          command:
            - "ansible-playbook"
            - "--tags=${APPS_TO_INSTALL}"
            - "-v"
            - "-i"
            - "localhost,"
            - "-e projects_suffix=${PROJECTS_SUFFIX}"
            - "-e ocadm=oc"
            - "-e ansible_connection=local"
            - "-e dns_wildcard=${DNS_WILDCARD}"
            - "-e gerrit_version=${GERRIT_VERSION}"
            - "-e gerrit_volume_capacity=${GERRIT_DATA_CAPACITY}"
            - "-e gerrit_volume_db_capacity=${GERRIT_DB_CAPACITY}"
            - "-e gerrit_job_version=${GERRIT_JOB_VERSION}"
            - "-e jenkins_enable_oauth=${JENKINS_ENABLE_OAUTH}"
            - "-e jenkins_fs_type=${JENKINS_FS_TYPE}"
            - "-e jenkins_host_path_volume=${JENKINS_HOST_PATH_VOLUME}"
            - "-e jenkins_volume_capacity=${JENKINS_VOLUME_CAPACITY}"
            - "-e jenkins_maven_cache_volume_capacity=${JENKINS_MAVEN_CACHE_VOLUME_CAPACITY}"
            - "-e jenkins_frontend_image=${JENKINS_FRONTEND_IMAGE}"
            - "-e jenkins_backend_image=${JENKINS_BACKEND_IMAGE}"
            - "-e nexus_version=${NEXUS_VERSION}"
            - "-e nexus_volume_capacity=${NEXUS_VOLUME_CAPACITY}"
            - "-e sonar_version=${SONAR_VERSION}"
            - "-e sonar_volume_capacity=${SONAR_VOLUME_CAPACITY}"
            - "-e sonar_volume_db_capacity=${SONAR_DB_CAPACITY}"
            - "-e cockpit_version=${EDP_COCKPIT_VERSION}"
            - "-e gitlab_oauth_app_id=${GITLAB_OAUTH_APP_ID}"
            - "-e gitlab_oauth_app_secret=${GITLAB_OAUTH_APP_SECRET}"
            - "-e gitlab_auto_user_secret=${GITLAB_AUTO_USER_SECRET}"
            - "-e gitlab_group_name=${GITLAB_GROUP_NAME_URL}"
            - "-e keycloak_image=${KEYCLOAK_IMAGE}"
            - "-e keycloak_volume_db_capacity=${KEYCLOAK_DB_CAPACITY}"
            - "-e keycloak_admin_user_secret=${KEYCLOAK_ADMIN_USER_SECRET}"
            - "ansible-playbooks/edp-deploy/install.yml"
parameters:
- displayName: DNS wildcard
  description: DNS wildcard of your project that should be specified during Openshift cluster installation
  name: DNS_WILDCARD
  value: ""
  required: true
- displayName: Image of EDP container
  description: Image and tag that defines version of EDP that will be deployed
  name: EDP_VERSION
  value: "docker-registry-default.main.edp.projects.epam.com/infra/edp-test:test"
- displayName: Suffix for projects
  description: Suffix that will be added to projects created by EDP Platform
  name: PROJECTS_SUFFIX
  value: "test"
- displayName: Applications to install
  description: For separate installation, defines what tools will be deployed during installation. For now it can be jenkins,nexus,gerrit,sonar,edp-cockpit.
  name: APPS_TO_INSTALL
  value: "all"
#Gerrit parameters
- displayName: Gerrit version
  value: "2.14.1"
  name: GERRIT_VERSION
- displayName: Gerrit Volume Capacity
  description: Volume space available for Gerrit data
  name: GERRIT_DATA_CAPACITY
  value: 5Gi
  required: true
- displayName: Gerrit database Volume Capacity
  description: Volume space available for Gerrit DB
  name: GERRIT_DB_CAPACITY
  value: 5Gi
  required: true
- displayName: Gerrit job version
  value: "docker-registry-default.main.edp.projects.epam.com/infra/edp-gerrit-job:latest"
  name: GERRIT_JOB_VERSION
#Jenkins parameters
- displayName: Jenkins filesystem type
  description: Allowed values only 'gluster' or 'hostpath'
  name: JENKINS_FS_TYPE
  value: "gluster"
  required: true
- displayName: Jenkins HostPath volume path
  description: Define it in case you chose 'hostpath' on the previous field. Otherwise, it should be ignored.
  name: JENKINS_HOST_PATH_VOLUME
  value: "/opt/data/jenkins"
- displayName: Enable OAuth in Jenkins
  description: Whether to enable OAuth OpenShift integration. If false, the static
    account 'admin' will be initialized with the password 'password'.
  displayName: Enable OAuth in Jenkins
  name: JENKINS_ENABLE_OAUTH
  value: "false"
- displayName: Volume Capacity
  description: Volume space available for Jenkins data
  name: JENKINS_VOLUME_CAPACITY
  value: 10Gi
  required: true
- displayName: Maven Cache Volume Capacity
  description: Volume space available for maven cache data
  name: JENKINS_MAVEN_CACHE_VOLUME_CAPACITY
  required: true
  value: 10Gi
- displayName: Frontend docker image.
  name: JENKINS_FRONTEND_IMAGE
  value: "docker-registry-default.main.edp.projects.epam.com/infra/edp-ui-slave:latest"
- displayName: Backend docker image.
  name: JENKINS_BACKEND_IMAGE
  value: "openshift/jenkins-slave-maven-centos7"
#Nexus parameters
- displayName: Sonatype Nexus version
  name: NEXUS_VERSION
  value: "3.6.2"
- displayName: Volume Space for Nexus
  description: Volume space available for Sonatype Nexus data
  name: NEXUS_VOLUME_CAPACITY
  value: 5Gi
#Sonar parameters
- displayName: SonarQube version
  value: "6.7"
  name: SONAR_VERSION
- description: Volume space available for SonarQube
  displayName: SonarQube Volume Capacity
  name: SONAR_VOLUME_CAPACITY
  value: 5Gi
- description: Volume space available for SonarQube Database
  displayName: SonarQube database Volume Capacity
  name: SONAR_DB_CAPACITY
  value: 5Gi
#EDP Cockpit parameters
- displayName: Version of edp-cockpit
  name: EDP_COCKPIT_VERSION
  value: "docker-registry-default.main.edp.projects.epam.com/infra/edp-cockpit:SNAPSHOT"
#GitLab parameters
- displayName: Gerrit Application ID
  description: Gerrit Application ID fot OAuth integration with Gitlab
  name: GITLAB_OAUTH_APP_ID
  value: ""
  required: true
- displayName: Gerrit Application Secret
  description: Gerrit Application Secret fot OAuth integration with Gitlab
  name: GITLAB_OAUTH_APP_SECRET
  value: ""
  required: true
- displayName: Git autouser secret name
  description: Git autouser secret name from prerequisites
  name: GITLAB_AUTO_USER_SECRET
  value: auto-epmc-java-vcs-with-ssh
  required: true
- displayName: GitLab group name URL
  description: GitLab URL to the project group. For example 'https://git.epam.com/epmd-edp/temp'
  name: GITLAB_GROUP_NAME_URL
  value: "https://git.epam.com/epmd-edp/temp"
  required: true
#Keycloak parameters
- displayName: Keycloak version
  name: KEYCLOAK_IMAGE
  value: "jboss/keycloak:3.4.3.Final"
- displayName: Keycloak database Volume Capacity
  description: Volume space available for Keycloak Database
  name: KEYCLOAK_DB_CAPACITY
  value: 2Gi
- displayName: Keycloak admin user secret name
  description: Keycloak admin user secret name from prerequisites
  name: KEYCLOAK_ADMIN_USER_SECRET
  value: keycloak
  required: true