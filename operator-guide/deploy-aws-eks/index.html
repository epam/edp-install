<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://epam.github.io/edp-install/operator-guide/deploy-aws-eks/ rel=canonical><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.9"><title>Deploy AWS EKS Cluster - EPAM Delivery Platform</title><link rel=stylesheet href=../../assets/stylesheets/main.2b4465f4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.e6a45f82.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-7ZV6PJ2LSP"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-7ZV6PJ2LSP",{page_path:e.pathname})})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-7ZV6PJ2LSP"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=cyan data-md-color-accent=blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#deploy-aws-eks-cluster class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="EPAM Delivery Platform" class="md-header__button md-logo" aria-label="EPAM Delivery Platform" data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> EPAM Delivery Platform </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Deploy AWS EKS Cluster </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=cyan data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary data-md-color-accent aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/epam/edp-install title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Overview </a> </li> <li class=md-tabs__item> <a href=../../features/ class=md-tabs__link> Basic Concepts </a> </li> <li class=md-tabs__item> <a href=../../getting-started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../ class="md-tabs__link md-tabs__link--active"> Operator Guide </a> </li> <li class=md-tabs__item> <a href=../../user-guide/ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../../developer-guide/ class=md-tabs__link> Developer Guide </a> </li> <li class=md-tabs__item> <a href=../../roadmap/ class=md-tabs__link> RoadMap </a> </li> <li class=md-tabs__item> <a href=../../use-cases/ class=md-tabs__link> Use Cases </a> </li> <li class=md-tabs__item> <a href=../../faq/ class=md-tabs__link> FAQ </a> </li> <li class=md-tabs__item> <a href=../../glossary/ class=md-tabs__link> Glossary </a> </li> <li class=md-tabs__item> <a href=https://github.com/epam/edp-install/blob/master/RELEASES.md class=md-tabs__link> Releases ⧉ </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="EPAM Delivery Platform" class="md-nav__button md-logo" aria-label="EPAM Delivery Platform" data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> EPAM Delivery Platform </label> <div class=md-nav__source> <a href=https://github.com/epam/edp-install title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../features/ class=md-nav__link> Basic Concepts </a> </li> <li class=md-nav__item> <a href=../../getting-started/ class=md-nav__link> Getting Started </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Operator Guide <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Operator Guide" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Operator Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> Overview </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Installation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Installation data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Installation </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2_1 type=checkbox id=__nav_4_2_1> <label class=md-nav__link for=__nav_4_2_1> Prerequisites <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Prerequisites data-md-level=3> <label class=md-nav__title for=__nav_4_2_1> <span class="md-nav__icon md-icon"></span> Prerequisites </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../install-ingress-nginx/ class=md-nav__link> Install Ingress-nginx </a> </li> <li class=md-nav__item> <a href=../install-keycloak/ class=md-nav__link> Install Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2_1_3 type=checkbox id=__nav_4_2_1_3> <label class=md-nav__link for=__nav_4_2_1_3> Kiosk <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kiosk data-md-level=4> <label class=md-nav__title for=__nav_4_2_1_3> <span class="md-nav__icon md-icon"></span> Kiosk </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../edp-kiosk-usage/ class=md-nav__link> EDP Kiosk Usage </a> </li> <li class=md-nav__item> <a href=../install-kiosk/ class=md-nav__link> Set Up Kiosk </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../kubernetes-cluster-settings/ class=md-nav__link> Set Up Kubernetes </a> </li> <li class=md-nav__item> <a href=../openshift-cluster-settings/ class=md-nav__link> Set Up OpenShift </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../install-edp/ class=md-nav__link> Install EDP </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> Configuration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Configuration data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../add-other-code-language/ class=md-nav__link> Add Other Code Language </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3_2 type=checkbox id=__nav_4_3_2> <label class=md-nav__link for=__nav_4_3_2> Backup With Velero <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Backup With Velero" data-md-level=3> <label class=md-nav__title for=__nav_4_3_2> <span class="md-nav__icon md-icon"></span> Backup With Velero </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../install-velero/ class=md-nav__link> Install Velero </a> </li> <li class=md-nav__item> <a href=../restore-edp-with-velero/ class=md-nav__link> Restore EDP Tenant With Velero </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../import-strategy/ class=md-nav__link> Enable VCS Import Strategy </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3_4 type=checkbox id=__nav_4_3_4> <label class=md-nav__link for=__nav_4_3_4> Manage Jenkins Pipelines <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Manage Jenkins Pipelines" data-md-level=3> <label class=md-nav__title for=__nav_4_3_4> <span class="md-nav__icon md-icon"></span> Manage Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../overview-manage-jenkins-pipelines/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../manage-jenkins-ci-job-provision/ class=md-nav__link> Manage Jenkins CI Pipeline Job Provisioner </a> </li> <li class=md-nav__item> <a href=../manage-jenkins-cd-job-provision/ class=md-nav__link> Manage Jenkins CD Pipeline Job Provisioner </a> </li> <li class=md-nav__item> <a href=../delete-jenkins-job-provision/ class=md-nav__link> Delete Jenkins Job Provision </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3_5 type=checkbox id=__nav_4_3_5> <label class=md-nav__link for=__nav_4_3_5> Logging <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Logging data-md-level=3> <label class=md-nav__title for=__nav_4_3_5> <span class="md-nav__icon md-icon"></span> Logging </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../install-loki/ class=md-nav__link> Install Grafana Loki </a> </li> <li class=md-nav__item> <a href=../multitenant-logging/ class=md-nav__link> Multitenant Logging </a> </li> <li class=md-nav__item> <a href=../schedule-pods-restart/ class=md-nav__link> Schedule Pods Restart </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Integration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Integration data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4_1 type=checkbox id=__nav_4_4_1> <label class=md-nav__link for=__nav_4_4_1> AWS Integration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="AWS Integration" data-md-level=3> <label class=md-nav__title for=__nav_4_4_1> <span class="md-nav__icon md-icon"></span> AWS Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../enable-irsa/ class=md-nav__link> Associate IAM Roles With Service Accounts </a> </li> <li class=md-nav__item> <a href=../kaniko-irsa/ class=md-nav__link> IAM Roles for Kaniko Service Accounts </a> </li> <li class=md-nav__item> <a href=../velero-irsa/ class=md-nav__link> IAM Roles for Velero Service Accounts </a> </li> <li class=md-nav__item> <a href=../loki-irsa/ class=md-nav__link> IAM Roles for Loki Service Accounts </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4_2 type=checkbox id=__nav_4_4_2> <label class=md-nav__link for=__nav_4_4_2> Jira Integration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Jira Integration" data-md-level=3> <label class=md-nav__title for=__nav_4_4_2> <span class="md-nav__icon md-icon"></span> Jira Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../jira-integration/ class=md-nav__link> Adjust Jira Integration </a> </li> <li class=md-nav__item> <a href=../jira-gerrit-integration/ class=md-nav__link> Adjust VCS Integration With Jira </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4_3 type=checkbox id=__nav_4_4_3> <label class=md-nav__link for=__nav_4_4_3> GitHub Integration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="GitHub Integration" data-md-level=3> <label class=md-nav__title for=__nav_4_4_3> <span class="md-nav__icon md-icon"></span> GitHub Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../github-integration/ class=md-nav__link> GitHub Integration </a> </li> <li class=md-nav__item> <a href=../github-debug-webhooks/ class=md-nav__link> Debug GitHub Webhooks in Jenkins </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4_4 type=checkbox id=__nav_4_4_4> <label class=md-nav__link for=__nav_4_4_4> GitLab Integration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="GitLab Integration" data-md-level=3> <label class=md-nav__title for=__nav_4_4_4> <span class="md-nav__icon md-icon"></span> GitLab Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../gitlab-integration/ class=md-nav__link> GitLab Integration </a> </li> <li class=md-nav__item> <a href=../gitlabci-integration/ class=md-nav__link> Adjust GitLab CI Tool </a> </li> <li class=md-nav__item> <a href=../gitlab-debug-webhooks/ class=md-nav__link> Debug GitLab Webhooks in Jenkins </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../perf-integration/ class=md-nav__link> Perf Server Integration </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5 type=checkbox id=__nav_4_5 checked> <label class=md-nav__link for=__nav_4_5> Upgrade <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Upgrade data-md-level=2> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Upgrade </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5_1 type=checkbox id=__nav_4_5_1> <label class=md-nav__link for=__nav_4_5_1> EDP on Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="EDP on Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_4_5_1> <span class="md-nav__icon md-icon"></span> EDP on Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../upgrade-edp-2.7.8-to-2.8.4/ class=md-nav__link> Upgrade EDP v.2.7.8 to v.2.8.4 </a> </li> <li class=md-nav__item> <a href=../upgrade-edp-2.8.4-to-2.9.0/ class=md-nav__link> Upgrade EDP v.2.8.4 to v.2.9.0 </a> </li> <li class=md-nav__item> <a href=../upgrade-edp-2.9.0-to-2.10.2/ class=md-nav__link> Upgrade EDP v.2.9.0 to v.2.10.2 </a> </li> <li class=md-nav__item> <a href=../upgrade-edp-unreleased/ class=md-nav__link> Unreleased </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5_2 type=checkbox id=__nav_4_5_2 checked> <label class=md-nav__link for=__nav_4_5_2> Tutorials <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Tutorials data-md-level=3> <label class=md-nav__title for=__nav_4_5_2> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Deploy AWS EKS Cluster <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Deploy AWS EKS Cluster </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> <nav class=md-nav aria-label=Prerequisites> <ul class=md-nav__list> <li class=md-nav__item> <a href=#required-tools class=md-nav__link> Required Tools </a> </li> <li class=md-nav__item> <a href=#aws-account-and-iam-roles class=md-nav__link> AWS Account and IAM Roles </a> </li> <li class=md-nav__item> <a href=#terraform-backend class=md-nav__link> Terraform Backend </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#deploy-eks-cluster class=md-nav__link> Deploy EKS Cluster </a> <nav class=md-nav aria-label="Deploy EKS Cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#eks-cluster-deployment-with-terraform class=md-nav__link> EKS Cluster Deployment with Terraform </a> </li> <li class=md-nav__item> <a href=#check-eks-cluster-deployment class=md-nav__link> Check EKS cluster deployment </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../add-jenkins-agent/ class=md-nav__link> Manage Jenkins Agent </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> User Guide <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="User Guide" data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/ class=md-nav__link> Overview </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_2 type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2> Application <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Application data-md-level=2> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Application </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/application/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../user-guide/add-application/ class=md-nav__link> Add Application </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_3 type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3> Autotest <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Autotest data-md-level=2> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> Autotest </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/autotest/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../user-guide/add-autotest/ class=md-nav__link> Add Autotests </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_4 type=checkbox id=__nav_5_4> <label class=md-nav__link for=__nav_5_4> Library <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Library data-md-level=2> <label class=md-nav__title for=__nav_5_4> <span class="md-nav__icon md-icon"></span> Library </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/library/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../user-guide/add-library/ class=md-nav__link> Add Library </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_5 type=checkbox id=__nav_5_5> <label class=md-nav__link for=__nav_5_5> Pipelines <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Pipelines data-md-level=2> <label class=md-nav__title for=__nav_5_5> <span class="md-nav__icon md-icon"></span> Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/cicd-overview/ class=md-nav__link> EDP CI/CD Overview </a> </li> <li class=md-nav__item> <a href=../../user-guide/pipeline-framework/ class=md-nav__link> EDP Pipeline Framework </a> </li> <li class=md-nav__item> <a href=../../user-guide/add-custom-global-pipeline-lib/ class=md-nav__link> Add Custom Pipeline Library </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_5_4 type=checkbox id=__nav_5_5_4> <label class=md-nav__link for=__nav_5_5_4> CI Pipeline <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="CI Pipeline" data-md-level=3> <label class=md-nav__title for=__nav_5_5_4> <span class="md-nav__icon md-icon"></span> CI Pipeline </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/ci-pipeline-details/ class=md-nav__link> CI Pipeline Details </a> </li> <li class=md-nav__item> <a href=../../user-guide/code-review-pipeline/ class=md-nav__link> Code Review Pipeline </a> </li> <li class=md-nav__item> <a href=../../user-guide/build-pipeline/ class=md-nav__link> Build Pipeline </a> </li> <li class=md-nav__item> <a href=../../user-guide/customize-ci-pipeline/ class=md-nav__link> Customize CI Pipeline </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_5_4_5 type=checkbox id=__nav_5_5_4_5> <label class=md-nav__link for=__nav_5_5_4_5> Stages <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Stages data-md-level=4> <label class=md-nav__title for=__nav_5_5_4_5> <span class="md-nav__icon md-icon"></span> Stages </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/pipeline-stages/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../user-guide/dockerfile-stages/ class=md-nav__link> Dockerfile </a> </li> <li class=md-nav__item> <a href=../../user-guide/ecr-to-docker-stages/ class=md-nav__link> Promote Docker Images From ECR to Docker Hub </a> </li> <li class=md-nav__item> <a href=../../user-guide/helm-stages/ class=md-nav__link> Helm </a> </li> <li class=md-nav__item> <a href=../../user-guide/opa-stages/ class=md-nav__link> Open Policy Agent </a> </li> <li class=md-nav__item> <a href=../../user-guide/terraform-stages/ class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=../../user-guide/container-stages/ class=md-nav__link> Container </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_5_5 type=checkbox id=__nav_5_5_5> <label class=md-nav__link for=__nav_5_5_5> CD Pipeline <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="CD Pipeline" data-md-level=3> <label class=md-nav__title for=__nav_5_5_5> <span class="md-nav__icon md-icon"></span> CD Pipeline </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/cd-pipeline-details/ class=md-nav__link> CD Pipeline Details </a> </li> <li class=md-nav__item> <a href=../../user-guide/add-cd-pipeline/ class=md-nav__link> Add CD Pipeline </a> </li> <li class=md-nav__item> <a href=../../user-guide/customize-cd-pipeline/ class=md-nav__link> Customize CD Pipeline </a> </li> <li class=md-nav__item> <a href=../../user-guide/prepare-for-release/ class=md-nav__link> Prepare for Release </a> </li> <li class=md-nav__item> <a href=../../user-guide/copy-shared-secrets/ class=md-nav__link> Copy Shared Secrets </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../user-guide/d-d-diagram/ class=md-nav__link> Delivery Dashboard Diagram </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Developer Guide <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Developer Guide" data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Developer Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../developer-guide/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../developer-guide/local-development/ class=md-nav__link> Local Development </a> </li> <li class=md-nav__item> <a href=../../developer-guide/rest-api/ class=md-nav__link> EDP API </a> </li> <li class=md-nav__item> <a href=../../developer-guide/mk-docs-development/ class=md-nav__link> Documentation Flow </a> </li> <li class=md-nav__item> <a href=../../developer-guide/edp-workflow/ class=md-nav__link> EDP Project Rules. Working Process </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../roadmap/ class=md-nav__link> RoadMap </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8> Use Cases <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Use Cases" data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Use Cases </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../use-cases/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../use-cases/autotest-as-quality-gate/ class=md-nav__link> Autotest as Quality Gate </a> </li> <li class=md-nav__item> <a href=../../use-cases/promotion-procedure/ class=md-nav__link> Promote Application in CD Pipeline </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../faq/ class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=../../glossary/ class=md-nav__link> Glossary </a> </li> <li class=md-nav__item> <a href=https://github.com/epam/edp-install/blob/master/RELEASES.md class=md-nav__link> Releases ⧉ </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> <nav class=md-nav aria-label=Prerequisites> <ul class=md-nav__list> <li class=md-nav__item> <a href=#required-tools class=md-nav__link> Required Tools </a> </li> <li class=md-nav__item> <a href=#aws-account-and-iam-roles class=md-nav__link> AWS Account and IAM Roles </a> </li> <li class=md-nav__item> <a href=#terraform-backend class=md-nav__link> Terraform Backend </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#deploy-eks-cluster class=md-nav__link> Deploy EKS Cluster </a> <nav class=md-nav aria-label="Deploy EKS Cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#eks-cluster-deployment-with-terraform class=md-nav__link> EKS Cluster Deployment with Terraform </a> </li> <li class=md-nav__item> <a href=#check-eks-cluster-deployment class=md-nav__link> Check EKS cluster deployment </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=deploy-aws-eks-cluster>Deploy AWS EKS Cluster<a class=headerlink href=#deploy-aws-eks-cluster title="Permanent link">⚓︎</a></h1> <p>This instruction provides detailed information on the Amazon Elastic Kubernetes Service cluster deployment and contains the additional setup necessary for the managed infrastructure.</p> <h2 id=prerequisites>Prerequisites<a class=headerlink href=#prerequisites title="Permanent link">⚓︎</a></h2> <p>Before the EKS cluster deployment and configuration, make sure to check the prerequisites.</p> <h4 id=required-tools>Required Tools<a class=headerlink href=#required-tools title="Permanent link">⚓︎</a></h4> <p>Install the required tools listed below:</p> <ul> <li><a href=https://git-scm.com/book/en/v2>Git</a></li> </ul> <ul> <li><a href=https://github.com/tfutils/tfenv>tfenv</a></li> </ul> <ul> <li><a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html>AWS CLI</a></li> </ul> <ul> <li><a href=https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html>kubectl</a></li> </ul> <ul> <li><a href=https://helm.sh/docs/intro/install/ >helm</a></li> </ul> <ul> <li><a href=https://k8slens.dev/ >lens</a> (optional)</li> </ul> <p>To check the correct tools installation, run the following commands:</p> <div class=codehilite><pre><span></span><code>$ git --version
$ tfenv --version
$ aws --version
$ kubectl version
$ helm version
</code></pre></div> <h4 id=aws-account-and-iam-roles>AWS Account and IAM Roles<a class=headerlink href=#aws-account-and-iam-roles title="Permanent link">⚓︎</a></h4> <ul> <li>Make sure the AWS account is active.</li> </ul> <ul> <li> <p>Create the AWS IAM role: EKSDeployerRole to deploy EKS cluster on the project side. The provided resources will allow to use cross-account deployment by assuming created EKSDeployerRole from the root AWS account. Take the following steps:</p> <ol> <li> <p>Clone git repo with ism-deployer project <a href=https://github.com/epmd-edp/edp-terraform-aws-platform.git>edp-terraform-aws-platform.git</a>, rename it corresponding to the project name.</p> <p><details> <summary><b> clone project</b></summary></p> <div class=codehilite><pre><span></span><code>$ git clone https://github.com/epmd-edp/edp-terraform-aws-platform.git
$ mv edp-terraform-aws-platform edp-terraform-aws-platform-&lt;PROJECT_NAME&gt;
$ <span class=nb>cd</span> edp-terraform-aws-platform-&lt;PROJECT_NAME&gt;/iam-deployer
</code></pre></div> </details> <p>where:</p> <ul> <li>&#8249;PROJECT_NAME&#8250; - is a project name, a unique platform identifier, e.g. shared, test-eks etc.</li> </ul> </li> <li> <p>Fill the input variables for Terraform run in the &#8249;iam-deployer/terraform.tfvars&#8250; file, refer to the <a href=https://github.com/epmd-edp/edp-terraform-aws-platform/blob/main/iam-deployer/template.tfvars>iam-deployer/template.tfvars</a> as an example.</p> <p><details> <summary><b>terraform.tfvars file example</b></summary></p> <div class=codehilite><pre><span></span><code><span class=n>aws_profile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;aws_user&quot;</span><span class=w></span>

<span class=n>region</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;eu-central-1&quot;</span><span class=w></span>

<span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>{</span><span class=w></span>
<span class=w>  </span><span class=ss>&quot;SysName&quot;</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;EKS&quot;</span><span class=w></span>
<span class=w>  </span><span class=ss>&quot;SysOwner&quot;</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;owner@example.com&quot;</span><span class=w></span>
<span class=w>  </span><span class=ss>&quot;Environment&quot;</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;EKS-TEST-CLUSTER&quot;</span><span class=w></span>
<span class=w>  </span><span class=ss>&quot;CostCenter&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;0000&quot;</span><span class=w></span>
<span class=w>  </span><span class=ss>&quot;BusinessUnit&quot;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;BU&quot;</span><span class=w></span>
<span class=w>  </span><span class=ss>&quot;Department&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;DEPARTMENT&quot;</span><span class=w></span>
<span class=err>}</span><span class=w></span>
</code></pre></div> </details> <p>Find the detailed description of the variables in the <a href=https://github.com/epmd-edp/edp-terraform-aws-platform/blob/main/iam-deployer/variables.tf>iam-deployer/variables.tf</a> file.</p> </li> <li> <p>Run Terraform apply. Initialize the backend and apply the changes.</p> <p><details> <summary><b>apply the changes</b></summary></p> <div class=codehilite><pre><span></span><code>$ terraform init
$ terraform apply
...
Do you want to perform these actions?
Terraform will perform the actions described above.
Only <span class=s1>&#39;yes&#39;</span> will be accepted to approve.

Enter a value: yes

aws_iam_role.deployer: Creating...
aws_iam_role.deployer: Creation <span class=nb>complete</span> after 4s <span class=o>[</span><span class=nv>id</span><span class=o>=</span>EKSDeployerRole<span class=o>]</span>

Apply complete! Resources: <span class=m>1</span> added, <span class=m>0</span> changed, <span class=m>0</span> destroyed.

Outputs:

<span class=nv>deployer_iam_role_arn</span> <span class=o>=</span> <span class=s2>&quot;arn:aws:iam::012345678910:role/EKSDeployerRole&quot;</span>
<span class=nv>deployer_iam_role_id</span> <span class=o>=</span> <span class=s2>&quot;EKSDeployerRole&quot;</span>
<span class=nv>deployer_iam_role_name</span> <span class=o>=</span> <span class=s2>&quot;EKSDeployerRole&quot;</span>
</code></pre></div> </details> </li> <li> <p>Commit the local state. At this run Terraform will use the <a href=https://www.terraform.io/docs/language/settings/backends/local.html>local backend</a> to store state on the local filesystem, locks that state using system APIs, and performs operations locally. There is no strong requirements to store the resulted state file in the git, but it's possible at will since there is no sensitive data. On your choice, commit the state of the s3-backend project or not.</p> <div class=codehilite><pre><span></span><code>$ git add iam-deployer/terraform.tfstate iam-deployer/terraform.tfvars
$ git commit -m <span class=s2>&quot;Terraform state for IAM deployer role&quot;</span>
</code></pre></div> </li> </ol> </li> </ul> <ul> <li>Configure AWS profile for deployment from the local node. Please, refer to the AWS documentation for <a href=https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/guide_credentials_profiles.html>detailed guide</a> to configure profiles.</li> </ul> <ul> <li>Create AWS Key pair for EKS cluster nodes access. Please refer to the AWS documentation for <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#having-ec2-create-your-key-pair>detailed guide</a> to create a Key pair.</li> </ul> <ul> <li>Create a public Hosted Zone if there is no any to provide for EKS cluster deployment. Please, refer to the AWS documentation for <a href=https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingHostedZone.html>detailed guide</a> to create a Hosted zone.</li> </ul> <h4 id=terraform-backend>Terraform Backend<a class=headerlink href=#terraform-backend title="Permanent link">⚓︎</a></h4> <p>Configure Terraform backend. The Terraform configuration for EKS cluster deployment has a backend block, which defines where and how operations are performed, where state snapshots are stored, etc. Currently, the best practice is to store the state as a given key in a given bucket on Amazon S3. This backend also supports state locking and consistency checking via Dynamo DB, which can be enabled by setting the dynamodb_table field to an existing DynamoDB table name.</p> <p>In the following configuration a single DynamoDB table can be used to lock multiple remote state files. Terraform generates key names that include the values of the bucket and key variables.</p> <p>In the <a href=https://github.com/epmd-edp/edp-terraform-aws-platform.git>edp-terraform-aws-platform.git</a> repo an optional project is provided to create initial resources to start using Terraform from the scratch.</p> <p>The provided resources will allow to use the following <strong>Terraform options</strong>:</p> <ul> <li>to store Terraform states remotely in the Amazon S3 bucket;</li> </ul> <ul> <li>to manage remote state access with S3 bucket policy;</li> </ul> <ul> <li>to support state locking and consistency checking via DynamoDB.</li> </ul> <p>After Terraform run the following <strong>AWS resources</strong> will be created:</p> <ul> <li>S3 bucket: terraform-states-&#8249;AWS_ACCOUNT_ID&#8250;</li> </ul> <ul> <li>S3 bucket policy: terraform-states-&#8249;AWS_ACCOUNT_ID&#8250;</li> </ul> <ul> <li>DynamoDB lock table: terraform_locks</li> </ul> <p>Please, skip this section if you already have the listed resources for further Terraform remote backend usage.</p> <p>To create the required resources, do the following:</p> <ol> <li> <p>Clone git repo with s3-backend project <a href=https://github.com/epmd-edp/edp-terraform-aws-platform.git>edp-terraform-aws-platform.git</a>, rename it in the correspondence with project name.</p> <p><details> <summary><b>clone project</b></summary></p> <div class=codehilite><pre><span></span><code>  $ git clone https://github.com/epmd-edp/edp-terraform-aws-platform.git

  $ mv edp-terraform-aws-platform tedp-terraform-aws-platform-&lt;PROJECT_NAME&gt;

  $ cd edp-terraform-aws-platform-&lt;PROJECT_NAME&gt;/s3-backend
</code></pre></div> </details> <p>where:</p> <p>&#8249;PROJECT_NAME&#8250; - is a project name, a unique platform identifier, e.g. shared, test-eks etc.</p> </li> <li> <p>Fill the input variables for Terraform run in the &#8249;s3-backend/terraform.tfvars&#8250; file, refer to the <a href=https://github.com/epmd-edp/edp-terraform-aws-platform/blob/main/s3-backend/template.tfvars>s3-backend/template.tfvars</a> as an example.</p> <p><details> <summary><b>terraform.tfvars file example</b></summary></p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=n>aws_profile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;aws_user&quot;</span><span class=w></span>

<span class=w>  </span><span class=n>region</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;eu-central-1&quot;</span><span class=w></span>

<span class=w>  </span><span class=n>s3_states_bucket_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;terraform-states&quot;</span><span class=w></span>

<span class=w>  </span><span class=n>table_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;terraform_locks&quot;</span><span class=w></span>

<span class=w>  </span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>{</span><span class=w></span>
<span class=w>    </span><span class=ss>&quot;SysName&quot;</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;EKS&quot;</span><span class=w></span>
<span class=w>    </span><span class=ss>&quot;SysOwner&quot;</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;owner@example.com&quot;</span><span class=w></span>
<span class=w>    </span><span class=ss>&quot;Environment&quot;</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;EKS-TEST-CLUSTER&quot;</span><span class=w></span>
<span class=w>    </span><span class=ss>&quot;CostCenter&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;0000&quot;</span><span class=w></span>
<span class=w>    </span><span class=ss>&quot;BusinessUnit&quot;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;BU&quot;</span><span class=w></span>
<span class=w>    </span><span class=ss>&quot;Department&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;DEPARTMENT&quot;</span><span class=w></span>
<span class=w>  </span><span class=err>}</span><span class=w></span>
</code></pre></div> </details> <p>Find the detailed description of the variables in the <a href=https://github.com/epmd-edp/edp-terraform-aws-platform/blob/main/s3-backend/variables.tf>s3-backend/variables.tf</a> file.</p> </li> <li> <p>Run Terraform apply. Initialize the backend and apply the changes.</p> <p><details> <summary><b>apply the changes</b></summary></p> <div class=codehilite><pre><span></span><code>  $ <span class=nv>terraform</span> <span class=nv>init</span>
  $ <span class=nv>terraform</span> <span class=nv>apply</span>
  ...
  <span class=k>Do</span> <span class=nv>you</span> <span class=nv>want</span> <span class=nv>to</span> <span class=nv>perform</span> <span class=nv>these</span> <span class=nv>actions</span>?
  <span class=nv>Terraform</span> <span class=nv>will</span> <span class=nv>perform</span> <span class=nv>the</span> <span class=nv>actions</span> <span class=nv>described</span> <span class=nv>above</span>.
  <span class=nv>Only</span> <span class=s1>&#39;</span><span class=s>yes</span><span class=s1>&#39;</span> <span class=nv>will</span> <span class=nv>be</span> <span class=nv>accepted</span> <span class=nv>to</span> <span class=nv>approve</span>.

  <span class=nv>Enter</span> <span class=nv>a</span> <span class=nv>value</span>: <span class=nv>yes</span>

  <span class=nv>aws_dynamodb_table</span>.<span class=nv>terraform_lock_table</span>: <span class=nv>Creating</span>...
  <span class=nv>aws_s3_bucket</span>.<span class=nv>terraform_states</span>: <span class=nv>Creating</span>...
  <span class=nv>aws_dynamodb_table</span>.<span class=nv>terraform_lock_table</span>: <span class=nv>Creation</span> <span class=nv>complete</span> <span class=nv>after</span> <span class=mi>27</span><span class=nv>s</span> [<span class=nv>id</span><span class=o>=</span><span class=nv>terraform</span><span class=o>-</span><span class=nv>locks</span><span class=o>-</span><span class=nv>test</span>]
  <span class=nv>aws_s3_bucket</span>.<span class=nv>terraform_states</span>: <span class=nv>Creation</span> <span class=nv>complete</span> <span class=nv>after</span> <span class=mi>1</span><span class=nv>m10s</span> [<span class=nv>id</span><span class=o>=</span><span class=nv>terraform</span><span class=o>-</span><span class=nv>states</span><span class=o>-</span><span class=nv>test</span><span class=o>-</span><span class=mi>012345678910</span>]
  <span class=nv>aws_s3_bucket_policy</span>.<span class=nv>terraform_states</span>: <span class=nv>Creating</span>...
  <span class=nv>aws_s3_bucket_policy</span>.<span class=nv>terraform_states</span>: <span class=nv>Creation</span> <span class=nv>complete</span> <span class=nv>after</span> <span class=mi>1</span><span class=nv>s</span> [<span class=nv>id</span><span class=o>=</span><span class=nv>terraform</span><span class=o>-</span><span class=nv>states</span><span class=o>-</span><span class=nv>test</span><span class=o>-</span><span class=mi>012345678910</span>]

  <span class=nv>Apply</span> <span class=nv>complete</span><span class=o>!</span> <span class=nv>Resources</span>: <span class=mi>3</span> <span class=nv>added</span>, <span class=mi>0</span> <span class=nv>changed</span>, <span class=mi>0</span> <span class=nv>destroyed</span>.

  <span class=nv>Outputs</span>:

  <span class=nv>terraform_lock_table_dynamodb_id</span> <span class=o>=</span> <span class=s2>&quot;</span><span class=s>terraform_locks</span><span class=s2>&quot;</span>
  <span class=nv>terraform_states_s3_bucket_name</span> <span class=o>=</span> <span class=s2>&quot;</span><span class=s>terraform-states-012345678910</span><span class=s2>&quot;</span>
</code></pre></div> </details> </li> <li> <p>Commit the local state. At this run Terraform will use the local backend to store state on the local filesystem, locks that state using system APIs, and performs operations locally. There is no strong requirements to store the resulted state file in the git, but it's possible at will since there is no sensitive data. On your choice, commit the state of the s3-backend project or not.</p> <div class=codehilite><pre><span></span><code>  $ <span class=nv>git</span> <span class=nv>add</span> <span class=nv>s3</span><span class=o>-</span><span class=nv>backend</span><span class=o>/</span><span class=nv>terraform</span>.<span class=nv>tfstate</span>

  $ <span class=nv>git</span> <span class=nv>commit</span> <span class=o>-</span><span class=nv>m</span> <span class=s2>&quot;</span><span class=s>Terraform state for s3-backend</span><span class=s2>&quot;</span>
</code></pre></div> <p>As a result, the projects that run Terraform can use the following definition for remote state configuration:</p> <details> <summary><b>providers.tf - terraform backend configuration block</b></summary> <div class=codehilite><pre><span></span><code><span class=n>terraform</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>backend</span><span class=w> </span><span class=s>&quot;s3&quot;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>bucket</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=s>&quot;terraform-states-&lt;AWS_ACCOUNT_ID&gt;&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>key</span><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&lt;PROJECT_NAME&gt;/&lt;REGION&gt;/terraform/terraform.tfstate&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>region</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&lt;REGION&gt;&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>acl</span><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=s>&quot;bucket-owner-full-control&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>dynamodb_table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;terraform_locks&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>encrypt</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=n>true</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> </details> <p>where:</p> <ul> <li>AWS_ACCOUNT_ID - is AWS account id, e.g. 012345678910,</li> <li>REGION - is AWS region, e.g. eu-central-1,</li> <li>PROJECT_NAME - is a project name, a unique platform identifier, e.g. shared, test-eks etc.</li> </ul> <details> <summary><b>View: providers.tf - terraform backend configuration example</b></summary> <div class=codehilite><pre><span></span><code><span class=n>terraform</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>backend</span><span class=w> </span><span class=s>&quot;s3&quot;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>bucket</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=s>&quot;terraform-states-012345678910&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>key</span><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=s>&quot;test-eks/eu-central-1/terraform/terraform.tfstate&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>region</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=s>&quot;eu-central-1&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>acl</span><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=s>&quot;bucket-owner-full-control&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>dynamodb_table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;terraform_locks&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>encrypt</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=n>true</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> </details> </li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>At the moment, it is recommended to use common s3 bucket and Dynamo DB in the root EDP account both for Shared and Standalone clusters deployment.</p> </div> <h2 id=deploy-eks-cluster>Deploy EKS Cluster<a class=headerlink href=#deploy-eks-cluster title="Permanent link">⚓︎</a></h2> <p>To deploy the EKS cluster, make sure that all the above-mentioned Prerequisites are ready to be used.</p> <h4 id=eks-cluster-deployment-with-terraform>EKS Cluster Deployment with Terraform<a class=headerlink href=#eks-cluster-deployment-with-terraform title="Permanent link">⚓︎</a></h4> <ol> <li> <p>Clone git repo with the Terraform project for EKS infrastructure <a href=https://github.com/epmd-edp/edp-terraform-aws-platform.git>edp-terraform-aws-platform.git</a> and rename it in the correspondence with project name if not yet.</p> <p><details> <summary><b>clone project</b></summary></p> <div class=codehilite><pre><span></span><code>  $ git clone https://github.com/epmd-edp/edp-terraform-aws-platform.git
  $ mv edp-terraform-aws-platform edp-terraform-aws-platform-&lt;PROJECT_NAME&gt;
  $ cd edp-terraform-aws-platform-&lt;PROJECT_NAME&gt;
</code></pre></div> </details> <p>where:</p> <ul> <li>&#8249;PROJECT_NAME&#8250; - is a project name, a unique platform identifier, e.g. shared, test-eks etc.</li> </ul> </li> <li> <p>Configure <a href=https://www.terraform.io/docs/language/settings/backends/configuration.html>Terraform backend</a> according to your project needs or use instructions from the Configure Terraform backend section.</p> </li> <li> <p>Fill the input variables for Terraform run in the &#8249;terraform.tfvars&#8250; file, refer to the <a href=https://github.com/epmd-edp/edp-terraform-aws-platform/blob/main/template.tfvars>template.tfvars</a> file and apply the changes. See details below. Be sure to put the correct values of the variables created in the Prerequisites section. Find the detailed description of the variables in the <a href=https://github.com/epmd-edp/edp-terraform-aws-platform/blob/main/variables.tf>variables.tf</a> file.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>Please, do not use upper case in the input variables. It can lead to unexpected issues.</p> </div> <details> <summary><b>template.tfvars file template</b></summary> <div class=codehilite><pre><span></span><code><span class=c1># Check out all the inputs based on the comments below and fill the gaps instead &lt;...&gt;</span><span class=w></span>
<span class=w>  </span><span class=c1># More details on each variable can be found in the variables.tf file</span><span class=w></span>

<span class=w>  </span><span class=n>create_vpc</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w> </span><span class=c1># set to true if you&#39;d like to create a new VPC or false if use existing</span><span class=w></span>
<span class=w>  </span><span class=n>create_cluster</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w> </span><span class=c1># set to false if there are any additional manual steps required between VPC and EKS cluster deployment</span><span class=w></span>
<span class=w>  </span><span class=n>create_elb</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w> </span><span class=c1># set to true if you&#39;d like to create ELB for Gerrit usage</span><span class=w></span>

<span class=w>  </span><span class=n>region</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;REGION&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>profile</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;AWS_PROFILE&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>role_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;ROLE_ARN&gt;&quot;</span><span class=w></span>

<span class=w>  </span><span class=n>platform_name</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;PLATFORM_NAME&gt;&quot;</span><span class=w>        </span><span class=c1># the name of the cluster and AWS resources</span><span class=w></span>
<span class=w>  </span><span class=n>platform_domain_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;PLATFORM_DOMAIN_NAME&gt;&quot;</span><span class=w> </span><span class=c1># must be created as a prerequisite</span><span class=w></span>
<span class=w>  </span><span class=n>wait_for_validation</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w>                     </span><span class=c1># set to false for use in an automated pipeline to avoid waiting for validation to complete or error after a 45 minute timeout.</span><span class=w></span>

<span class=w>  </span><span class=c1># The following will be created or used existing depending on the create_vpc value</span><span class=w></span>
<span class=w>  </span><span class=n>subnet_azs</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;&lt;SUBNET_AZS1&gt;&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;&lt;SUBNET_AZS2&gt;&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=n>platform_cidr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;PLATFORM_CIDR&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>private_cidrs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;&lt;PRIVATE_CIDRS1&gt;&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;&lt;PRIVATE_CIDRS2&gt;&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=n>public_cidrs</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;&lt;PUBLIC_CIDRS1&gt;&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;&lt;PUBLIC_CIDRS2&gt;&quot;</span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=c1># Define the following only if you&#39;re going to use existing VPC and create_vpc is set to false</span><span class=w></span>
<span class=w>  </span><span class=n>vpc_id</span><span class=w>             </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;VPC_ID&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>private_subnets_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;&lt;PRIVATE_SUBNETS_ID1&gt;&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;&lt;PRIVATE_SUBNETS_ID2&gt;&quot;</span><span class=p>]</span><span class=w> </span><span class=c1># &quot;&lt;SUBNET_AZS1&gt;&quot;, &quot;&lt;SUBNET_AZS2&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>public_subnets_id</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;&lt;PUBLIC_SUBNETS_ID1&gt;&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;&lt;PUBLIC_SUBNETS_ID2&gt;&quot;</span><span class=p>]</span><span class=w>   </span><span class=c1># &quot;&lt;SUBNET_AZS1&gt;&quot;, &quot;&lt;SUBNET_AZS2&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>nat_public_ips</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;&lt;NAT_PUBLIC_IP&gt;&quot;</span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=c1># Define CIDR blocks and/or prefix lists if any to whitelist for public access on LBs</span><span class=w></span>
<span class=w>  </span><span class=n>ingress_cidr_blocks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;&lt;PUBLIC_CIDR&gt;&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=n>ingress_prefix_list_ids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>description</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;SHORT_DESCRIPTION1&quot;</span><span class=w></span>
<span class=w>      </span><span class=n>public_prefix_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;PREFIX_LIST_ID1&gt;&quot;</span><span class=w></span>
<span class=w>    </span><span class=p>},</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>description</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;SHORT_DESCRIPTION2&quot;</span><span class=w></span>
<span class=w>      </span><span class=n>public_prefix_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;PREFIX_LIST_ID2&gt;&quot;</span><span class=w></span>
<span class=w>    </span><span class=p>},</span><span class=w></span>
<span class=w>  </span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=c1># Define existing security groups ids if any in order to whitelist for public access on LBs. Makes sense with create_vpc = true only.</span><span class=w></span>
<span class=w>  </span><span class=n>public_security_group_ids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;&lt;PUBLIC_SECURITY_GROUP_IDS1&gt;&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;&lt;PUBLIC_SECURITY_GROUP_IDS2&gt;&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>  </span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=c1># EKS cluster configuration</span><span class=w></span>
<span class=w>  </span><span class=n>cluster_version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;1.18&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>key_name</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;AWS_KEY_PAIR_NAME&gt;&quot;</span><span class=w> </span><span class=c1># must be created as a prerequisite</span><span class=w></span>
<span class=w>  </span><span class=n>enable_irsa</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w></span>

<span class=w>  </span><span class=n>manage_cluster_iam_resources</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w> </span><span class=c1># if set to false, cluster_iam_role_name must be specified</span><span class=w></span>
<span class=w>  </span><span class=n>manage_worker_iam_resources</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w> </span><span class=c1># if set to false, worker_iam_instance_profile_name must be specified for workers</span><span class=w></span>
<span class=w>  </span><span class=n>cluster_iam_role_name</span><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;SERVICE_ROLE_FOR_EKS&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>worker_iam_instance_profile_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;SERVICE_ROLE_FOR_EKS_WORKER_NODE&quot;</span><span class=w></span>

<span class=w>  </span><span class=c1># Uncomment if your AWS CLI version is 1.16.156 or later</span><span class=w></span>
<span class=w>  </span><span class=n>kubeconfig_aws_authenticator_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;aws&quot;</span><span class=w></span>

<span class=w>  </span><span class=c1># Environment varibles to put into kubeconfig file to use when executing the authentication, such as AWS profile of IAM user for authentication</span><span class=w></span>
<span class=w>  </span><span class=n>kubeconfig_aws_authenticator_env_variables</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>AWS_PROFILE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;AWS_PROFILE&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>add_userdata</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=n>EOF</span><span class=w></span>
<span class=w>  </span><span class=k>export</span><span class=w> </span><span class=n>TOKEN</span><span class=o>=$</span><span class=p>(</span><span class=n>aws</span><span class=w> </span><span class=n>ssm</span><span class=w> </span><span class=n>get</span><span class=o>-</span><span class=n>parameter</span><span class=w> </span><span class=o>--</span><span class=n>name</span><span class=w> </span><span class=n>edprobot</span><span class=w> </span><span class=o>--</span><span class=n>query</span><span class=w> </span><span class=s1>&#39;Parameter.Value&#39;</span><span class=w> </span><span class=o>--</span><span class=n>region</span><span class=w> </span><span class=n>eu</span><span class=o>-</span><span class=n>central</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=o>--</span><span class=n>output</span><span class=w> </span><span class=n>text</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=n>cat</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=n>DATA</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubelet</span><span class=o>/</span><span class=n>config</span><span class=o>.</span><span class=n>json</span><span class=w></span>
<span class=w>  </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;auths&quot;</span><span class=p>:{</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;https://index.docker.io/v1/&quot;</span><span class=p>:{</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;auth&quot;</span><span class=p>:</span><span class=s2>&quot;$TOKEN&quot;</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>     </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=n>DATA</span><span class=w></span>
<span class=w>  </span><span class=n>EOF</span><span class=w></span>

<span class=w>  </span><span class=n>map_users</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;userarn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&lt;IAM_USER_ARN1&gt;&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&lt;IAM_USER_NAME1&gt;&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>    </span><span class=p>},</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;userarn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&lt;IAM_USER_ARN2&gt;&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&lt;IAM_USER_NAME2&gt;&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=n>map_roles</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;rolearn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&lt;IAM_ROLE_ARN1&gt;&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&lt;IAM_ROLE_NAME1&gt;&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>    </span><span class=p>},</span><span class=w></span>
<span class=w>  </span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>   </span><span class=s2>&quot;SysName&quot;</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;SYS_NAME&gt;&quot;</span><span class=w></span>
<span class=w>   </span><span class=s2>&quot;SysOwner&quot;</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;SYSTEM_OWNER&gt;&quot;</span><span class=w></span>
<span class=w>   </span><span class=s2>&quot;Environment&quot;</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;ENVIRONMENT&gt;&quot;</span><span class=w></span>
<span class=w>   </span><span class=s2>&quot;CostCenter&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;COST_CENTER&gt;&quot;</span><span class=w></span>
<span class=w>   </span><span class=s2>&quot;BusinessUnit&quot;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;BUSINESS_UNIT&gt;&quot;</span><span class=w></span>
<span class=w>   </span><span class=s2>&quot;Department&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;DEPARTMENT&gt;&quot;</span><span class=w></span>
<span class=w>   </span><span class=s2>&quot;user:tag&quot;</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&lt;PLATFORM_NAME&gt;&quot;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>demand_instance_types</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;r5.large&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=n>spot_instance_types</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;r5.large&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;r4.large&quot;</span><span class=p>]</span><span class=w> </span><span class=c1># need to ensure we use nodes with more memory</span><span class=w></span>
</code></pre></div> </details> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The file above is an example. Please find the latest version in the project repo in the <a href=https://github.com/epmd-edp/edp-terraform-aws-platform/blob/main/template.tfvars>terraform.tfvars</a> file.</p> </div> <p><strong>There are the following possible scenarios to deploy the EKS cluster:</strong></p> <details> <summary><b>Case 1: Create new VPC and deploy the EKS cluster, terraform.tfvars file example</b></summary> <div class=codehilite><pre><span></span><code><span class=n>create_vpc</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w> </span><span class=c1># set to true if you&#39;d like to create a new VPC or false if use existing</span><span class=w></span>
<span class=n>create_cluster</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w> </span><span class=c1># set to false if there are any additional manual steps required between VPC and EKS cluster deployment</span><span class=w></span>
<span class=n>create_elb</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w> </span><span class=c1># set to true if you&#39;d like to create ELB for Gerrit usage</span><span class=w></span>

<span class=n>region</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;eu-central-1&quot;</span><span class=w></span>
<span class=n>profile</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;aws_user&quot;</span><span class=w></span>
<span class=n>role_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::012345678910:role/EKSDeployerRole&quot;</span><span class=w></span>

<span class=n>platform_name</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test-eks&quot;</span><span class=w></span>
<span class=n>platform_domain_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;example.com&quot;</span><span class=w> </span><span class=c1># must be created as a prerequisite</span><span class=w></span>
<span class=n>wait_for_validation</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w>          </span><span class=c1># set to false for use in an automated pipeline to avoid waiting for validation to complete or error after a 45 minute timeout.</span><span class=w></span>

<span class=c1># The following will be created or used existing depending on the create_vpc value</span><span class=w></span>
<span class=n>subnet_azs</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;eu-central-1a&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;eu-central-1b&quot;</span><span class=p>]</span><span class=w></span>
<span class=n>platform_cidr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;172.31.0.0/16&quot;</span><span class=w></span>
<span class=n>private_cidrs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;172.31.0.0/20&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;172.31.16.0/20&quot;</span><span class=p>]</span><span class=w></span>
<span class=n>public_cidrs</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;172.31.32.0/20&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;172.31.48.0/20&quot;</span><span class=p>]</span><span class=w></span>

<span class=c1># Define CIDR blocks and/or prefix lists if any to whitelist for public access on LBs. Use short description</span><span class=w></span>
<span class=n>ingress_cidr_blocks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;192.168.64.0/24&quot;</span><span class=p>]</span><span class=w></span>
<span class=n>ingress_prefix_list_ids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>  </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>description</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;europe&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>public_prefix_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;pl-00000000000000002&quot;</span><span class=w></span>
<span class=w>  </span><span class=p>},</span><span class=w></span>
<span class=w>  </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>description</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;world&quot;</span><span class=w></span>
<span class=w>    </span><span class=n>public_prefix_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;pl-00000000000000003&quot;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>]</span><span class=w></span>

<span class=c1># EKS cluster configuration</span><span class=w></span>
<span class=n>cluster_version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;1.18&quot;</span><span class=w></span>
<span class=n>key_name</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test-kn&quot;</span><span class=w> </span><span class=c1># must be created as a prerequisite</span><span class=w></span>
<span class=n>enable_irsa</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w></span>

<span class=c1># Define if IAM roles should be created during the deployment or used existing ones</span><span class=w></span>
<span class=n>manage_cluster_iam_resources</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w> </span><span class=c1># if set to false, cluster_iam_role_name must be specified</span><span class=w></span>
<span class=n>manage_worker_iam_resources</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w> </span><span class=c1># if set to false, worker_iam_instance_profile_name must be specified for workers</span><span class=w></span>
<span class=n>cluster_iam_role_name</span><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;ServiceRoleForEKSShared&quot;</span><span class=w></span>
<span class=n>worker_iam_instance_profile_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;ServiceRoleForEksSharedWorkerNode&quot;</span><span class=w></span>

<span class=c1># Uncomment if your AWS CLI version is 1.16.156 or later</span><span class=w></span>
<span class=n>kubeconfig_aws_authenticator_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;aws&quot;</span><span class=w></span>

<span class=c1># Environment varibles to put into kubeconfig file to use when executing the authentication, such as AWS profile of IAM user for authentication</span><span class=w></span>
<span class=n>kubeconfig_aws_authenticator_env_variables</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>AWS_PROFILE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;aws_user&quot;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>add_userdata</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=n>EOF</span><span class=w></span>
<span class=k>export</span><span class=w> </span><span class=n>TOKEN</span><span class=o>=$</span><span class=p>(</span><span class=n>aws</span><span class=w> </span><span class=n>ssm</span><span class=w> </span><span class=n>get</span><span class=o>-</span><span class=n>parameter</span><span class=w> </span><span class=o>--</span><span class=n>name</span><span class=w> </span><span class=n>edprobot</span><span class=w> </span><span class=o>--</span><span class=n>query</span><span class=w> </span><span class=s1>&#39;Parameter.Value&#39;</span><span class=w> </span><span class=o>--</span><span class=n>region</span><span class=w> </span><span class=n>eu</span><span class=o>-</span><span class=n>central</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=o>--</span><span class=n>output</span><span class=w> </span><span class=n>text</span><span class=p>)</span><span class=w></span>
<span class=n>cat</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=n>DATA</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubelet</span><span class=o>/</span><span class=n>config</span><span class=o>.</span><span class=n>json</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;auths&quot;</span><span class=p>:{</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;https://index.docker.io/v1/&quot;</span><span class=p>:{</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;auth&quot;</span><span class=p>:</span><span class=s2>&quot;$TOKEN&quot;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
<span class=n>DATA</span><span class=w></span>
<span class=n>EOF</span><span class=w></span>

<span class=n>map_users</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>  </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;userarn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::012345678910:user/user_name1@example.com&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;user_name1@example.com&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=p>},</span><span class=w></span>
<span class=w>  </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;userarn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::012345678910:user/user_name2@example.com&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;user_name2@example.com&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>]</span><span class=w></span>

<span class=n>map_roles</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>  </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;rolearn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::012345678910:role/EKSClusterAdminRole&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;eksadminrole&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=p>},</span><span class=w></span>
<span class=p>]</span><span class=w></span>

<span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;SysName&quot;</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;EKS&quot;</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;SysOwner&quot;</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;owner@example.com&quot;</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;Environment&quot;</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;EKS-TEST-CLUSTER&quot;</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;CostCenter&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;2020&quot;</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;BusinessUnit&quot;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;BU&quot;</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;Department&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;DEPARTMENT&quot;</span><span class=w></span>
<span class=w>  </span><span class=s2>&quot;user:tag&quot;</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test-eks&quot;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>demand_instance_types</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;r5.large&quot;</span><span class=p>]</span><span class=w></span>
<span class=n>spot_instance_types</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;r5.large&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;r4.large&quot;</span><span class=p>]</span><span class=w> </span><span class=c1># need to ensure we use nodes with more memory</span><span class=w></span>
</code></pre></div> </details> <details> <summary><b>Case 2: Use existing VPC to deploy EKS cluster, terraform.tfvars file example</b></summary> <div class=codehilite><pre><span></span><code><span class=n>create_vpc</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w> </span><span class=c1># set to true if you&#39;d like to create a new VPC or false if use existing</span><span class=w></span>
<span class=w>  </span><span class=n>create_cluster</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w> </span><span class=c1># set to false if there are any additional manual steps required between VPC and EKS cluster deployment</span><span class=w></span>
<span class=w>  </span><span class=n>create_elb</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w> </span><span class=c1># set to true if you&#39;d like to create ELB for Gerrit usage</span><span class=w></span>

<span class=w>  </span><span class=n>region</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;eu-central-1&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>profile</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;aws_user&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>role_arn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::012345678910:role/EKSDeployerRole&quot;</span><span class=w></span>

<span class=w>  </span><span class=n>platform_name</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test-eks&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>platform_domain_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;example.com&quot;</span><span class=w> </span><span class=c1># must be created as a prerequisite</span><span class=w></span>
<span class=w>  </span><span class=n>wait_for_validation</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w>          </span><span class=c1># set to false for use in an automated pipeline to avoid waiting for validation to complete or error after a 45 minute timeout.</span><span class=w></span>

<span class=w>  </span><span class=c1># The following will be created or used existing depending on the create_vpc value</span><span class=w></span>
<span class=w>  </span><span class=n>subnet_azs</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;eu-central-1a&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;eu-central-1b&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=n>platform_cidr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;172.31.0.0/16&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>private_cidrs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;172.31.0.0/20&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;172.31.16.0/20&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=n>public_cidrs</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;172.31.32.0/20&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;172.31.48.0/20&quot;</span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=c1># Define the following only if you&#39;re going to use existing VPC and create_vpc is set to false</span><span class=w></span>
<span class=w>  </span><span class=n>vpc_id</span><span class=w>             </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;vpc-00000000000000000&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>private_subnets_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;subnet-00000000000000001&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;subnet-00000000000000002&quot;</span><span class=p>]</span><span class=w> </span><span class=c1># eu-central-1a, eu-central-1b</span><span class=w></span>
<span class=w>  </span><span class=n>public_subnets_id</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;subnet-00000000000000003&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;subnet-00000000000000004&quot;</span><span class=p>]</span><span class=w> </span><span class=c1># eu-central-1a, eu-central-1b</span><span class=w></span>
<span class=w>  </span><span class=n>nat_public_cidrs</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;10.11.12.13/32&quot;</span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=c1># Define CIDR blocks and/or prefix lists if any to whitelist for public access on LBs. Use short description</span><span class=w></span>
<span class=w>  </span><span class=n>ingress_cidr_blocks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;192.168.64.0/24&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=n>ingress_prefix_list_ids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>description</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;europe&quot;</span><span class=w></span>
<span class=w>      </span><span class=n>public_prefix_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;pl-00000000000000002&quot;</span><span class=w></span>
<span class=w>    </span><span class=p>},</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>description</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;world&quot;</span><span class=w></span>
<span class=w>      </span><span class=n>public_prefix_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;pl-00000000000000003&quot;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=c1># Define existing security groups ids if any in order to whitelist for public access on LBs. Makes sense with create_vpc = false only.</span><span class=w></span>
<span class=w>  </span><span class=n>public_security_group_ids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;sg-00000000000000001&quot;</span><span class=p>,</span><span class=w> </span><span class=c1># Europe</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;sg-00000000000000002&quot;</span><span class=p>,</span><span class=w> </span><span class=c1># Global</span><span class=w></span>
<span class=w>  </span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=c1># EKS cluster configuration</span><span class=w></span>
<span class=w>  </span><span class=n>cluster_version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;1.18&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>key_name</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test-kn&quot;</span><span class=w> </span><span class=c1># must be created as a prerequisite</span><span class=w></span>
<span class=w>  </span><span class=n>enable_irsa</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>true</span><span class=w></span>

<span class=w>  </span><span class=c1># Define if IAM roles should be created during the deployment or used existing ones</span><span class=w></span>
<span class=w>  </span><span class=n>manage_cluster_iam_resources</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w> </span><span class=c1># if set to false, cluster_iam_role_name must be specified</span><span class=w></span>
<span class=w>  </span><span class=n>manage_worker_iam_resources</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=bp>false</span><span class=w> </span><span class=c1># if set to false, worker_iam_instance_profile_name must be specified for workers</span><span class=w></span>
<span class=w>  </span><span class=n>cluster_iam_role_name</span><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;ServiceRoleForEKSShared&quot;</span><span class=w></span>
<span class=w>  </span><span class=n>worke</span><span class=w></span>

<span class=w>  </span><span class=c1># Uncomment if your AWS CLI version is 1.16.156 or later</span><span class=w></span>
<span class=w>  </span><span class=n>kubeconfig_aws_authenticator_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;aws&quot;</span><span class=w></span>

<span class=w>  </span><span class=c1># Environment varibles to put into kubeconfig file to use when executing the authentication, such as AWS profile of IAM user for authentication</span><span class=w></span>
<span class=w>  </span><span class=n>kubeconfig_aws_authenticator_env_variables</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>AWS_PROFILE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;aws_user&quot;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>add_userdata</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=n>EOF</span><span class=w></span>
<span class=w>  </span><span class=k>export</span><span class=w> </span><span class=n>TOKEN</span><span class=o>=$</span><span class=p>(</span><span class=n>aws</span><span class=w> </span><span class=n>ssm</span><span class=w> </span><span class=n>get</span><span class=o>-</span><span class=n>parameter</span><span class=w> </span><span class=o>--</span><span class=n>name</span><span class=w> </span><span class=n>edprobot</span><span class=w> </span><span class=o>--</span><span class=n>query</span><span class=w> </span><span class=s1>&#39;Parameter.Value&#39;</span><span class=w> </span><span class=o>--</span><span class=n>region</span><span class=w> </span><span class=n>eu</span><span class=o>-</span><span class=n>central</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=o>--</span><span class=n>output</span><span class=w> </span><span class=n>text</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=n>cat</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=n>DATA</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubelet</span><span class=o>/</span><span class=n>config</span><span class=o>.</span><span class=n>json</span><span class=w></span>
<span class=w>  </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;auths&quot;</span><span class=p>:{</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;https://index.docker.io/v1/&quot;</span><span class=p>:{</span><span class=w></span>
<span class=w>        </span><span class=s2>&quot;auth&quot;</span><span class=p>:</span><span class=s2>&quot;$TOKEN&quot;</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=n>DATA</span><span class=w></span>
<span class=w>  </span><span class=n>EOF</span><span class=w></span>

<span class=w>  </span><span class=n>map_users</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;userarn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::012345678910:user/user_name1@example.com&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;user_name1@example.com&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>    </span><span class=p>},</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;userarn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::012345678910:user/user_name2@example.com&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;user_name2@example.com&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=n>map_roles</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;rolearn&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;arn:aws:iam::012345678910:role/EKSClusterAdminRole&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;username&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;eksadminrole&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;groups&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;system:masters&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>    </span><span class=p>},</span><span class=w></span>
<span class=w>  </span><span class=p>]</span><span class=w></span>

<span class=w>  </span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;SysName&quot;</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;EKS&quot;</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;SysOwner&quot;</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;owner@example.com&quot;</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;Environment&quot;</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;EKS-TEST-CLUSTER&quot;</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;CostCenter&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;2020&quot;</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;BusinessUnit&quot;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;BU&quot;</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;Department&quot;</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;DEPARTMENT&quot;</span><span class=w></span>
<span class=w>    </span><span class=s2>&quot;user:tag&quot;</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test-eks&quot;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>demand_instance_types</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;r5.large&quot;</span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=n>spot_instance_types</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;r5.large&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;r4.large&quot;</span><span class=p>]</span><span class=w> </span><span class=c1># need to ensure we use nodes with more memory</span><span class=w></span>
</code></pre></div> </details> </li> <li> <p>Run Terraform apply. Initialize the backend and apply the changes.</p> <details> <summary><b>apply the changes</b></summary> <div class=codehilite><pre><span></span><code>   $ <span class=nv>terraform</span> <span class=nv>init</span>
   $ <span class=nv>terraform</span> <span class=nv>apply</span>
   ...

   <span class=k>Do</span> <span class=nv>you</span> <span class=nv>want</span> <span class=nv>to</span> <span class=nv>perform</span> <span class=nv>these</span> <span class=nv>actions</span>?
   <span class=nv>Terraform</span> <span class=nv>will</span> <span class=nv>perform</span> <span class=nv>the</span> <span class=nv>actions</span> <span class=nv>described</span> <span class=nv>above</span>.
   <span class=nv>Only</span> <span class=s1>&#39;</span><span class=s>yes</span><span class=s1>&#39;</span> <span class=nv>will</span> <span class=nv>be</span> <span class=nv>accepted</span> <span class=nv>to</span> <span class=nv>approve</span>.
   <span class=nv>Enter</span> <span class=nv>a</span> <span class=nv>value</span>: <span class=nv>yes</span>
   ...
</code></pre></div> </details> </li> </ol> <h4 id=check-eks-cluster-deployment>Check EKS cluster deployment<a class=headerlink href=#check-eks-cluster-deployment title="Permanent link">⚓︎</a></h4> <p>As a result, the &#8249;PLATFORM_NAME&#8250; EKS cluster is deployed to the specified AWS account.</p> <p>Make sure you have all required tools listed in the Install required tools section.</p> <p>To connect to the cluster find the <strong>kubeconfig</strong>_<platform_name> file in the project folder which is output of the last Terraform apply run. Move it to the <strong>~/.kube/</strong> folder.</p> <div class=codehilite><pre><span></span><code>    $ mv kubeconfig_&lt;PLATFORM_NAME&gt; ~/.kube/
</code></pre></div> <p>Run the following commands to ensure the EKS cluster is up and has required nodes count:</p> <div class=codehilite><pre><span></span><code>    $ kubectl config get-contexts
    $ kubectl get nodes
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>If the there are any authorisation issues, make sure the users section in the kubeconfig_<platform_name> file has all required parameters based on you AWS CLI version. Find more details in the <a href=https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html#create-kubeconfig-manually>create kubeconfig</a> AWS user guide. And pay attention on the kubeconfig_aws_authenticator terraform input variables.</p> </div> <p>Optionally, a <a href=https://k8slens.dev/ >Lens</a> tool can be installed and used for further work with Kubernetes cluster. Refer to the <a href=https://docs.k8slens.dev/main/ >original documentation</a> to add and process the cluster.</p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../upgrade-edp-unreleased/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Unreleased" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Unreleased </div> </div> </a> <a href=../add-jenkins-agent/ class="md-footer__link md-footer__link--next" aria-label="Next: Manage Jenkins Agent" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Manage Jenkins Agent </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://hub.docker.com/u/epamedp target=_blank rel=noopener title=hub.docker.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.sections", "navigation.tabs", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.22074ed6.min.js"}</script> <script src=../../assets/javascripts/bundle.960e086b.min.js></script> </body> </html>